<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="stylesheet" href="css/common.css">

    <title>Media Layers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"
      integrity="sha512-yNJzAsg5JyP91u+sLHlUDULMBd3hmEiVkYeeN1cQBKaLZ7EyT6oH2u5THNIRM2Fu6VKcZJv+F/QAp1h/qzy9Ow=="
      crossorigin="anonymous"></script>
  </head>
  <body>
    <header>
      <details open>
        <summary>Media Layers</summary>
        <p>
          Demonstrates using the Media Layers API to create a high-quality video player inside of an "immersive-vr" session.
          <a class="back" href="./">Back</a>
        </p>
        <label>Choose the media"s layout:</label>
        <select id="layoutselect">
          <option value="./media/video/60fps.mp4">
            mono
          </option>
          <option value="./media/video/bbb-sunflower-540p2-1min.webm">
            stereo-top-bottom
          </option>
        </select>
        <p>Trigger = Squeeze = play / pause the video</p>
      </details>
    </header>
    <main style="text-align: center;">
      <p>Click "Enter VR" to see content</p>
    </main>
    <script type="module">
      import { WebXRButton } from "./js/util/webxr-button.js";
      import { QueryArgs } from "./js/util/query-args.js";

      // If requested, use the polyfill to provide support for mobile devices
      // and devices which only support WebVR.
      import WebXRPolyfill from "./js/third-party/webxr-polyfill/build/webxr-polyfill.module.js";
      if (QueryArgs.getBool("usePolyfill", true)) {
        let polyfill = new WebXRPolyfill();
      }

      let xrButton = null;
      const RANGE = 2.75;
      const SPRITE_SCALE = 550;

      let refSpace = null;
      let session = null;

      let layoutSelect = null;
      let videoPlayer = null;

      let lastHandedness = null;

      function initXR() {
        xrButton = new WebXRButton({ onRequestSession, onEndSession });
        document.querySelector("header").appendChild(xrButton.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported("immersive-vr").then(supported => {
            xrButton.enabled = supported;
          });
        }
      }

      function onRequestSession() {
        navigator.xr.requestSession("immersive-vr", {
          requiredFeatures: ["layers", "local-floor"],
        }).then(session => {
          xrButton.setSession(session);
          initializeSession(session);
        });
      }

      async function initializeSession(session) {
        layoutSelect = document.getElementById("layoutselect");
        const { text, value } = layoutSelect.options[layoutSelect.selectedIndex];
        videoPlayer = new VideoPlayer(text, value);
        await videoPlayer.initializeXRBindings(session);
        startSession(session);
      }

      async function startSession(session) {
        session.requestReferenceSpace("local-floor")
          .then(async (referenceSpace) => {
            refSpace = referenceSpace;
            const [quadMediaLayer, quadWebGlLayer] = await videoPlayer.createQuadMediaLayer(refSpace);
            const [equirectMediaLayer] = await videoPlayer.createEquirectMediaLayer(refSpace);

            session.addEventListener("squeeze", evt => {
              if (videoPlayer.isPlaying) videoPlayer.video.pause();
              else videoPlayer.video.play();
            });

            session.addEventListener("select", evt => {
              if (videoPlayer.isPlaying) videoPlayer.video.pause();
              else videoPlayer.video.play();
            });

            const layers = [equirectMediaLayer, quadMediaLayer, quadWebGlLayer];
            session.updateRenderState({ layers });
            
            videoPlayer.video.play();
            session.requestAnimationFrame(onAnimationFrame);            
          });
      }

      function onAnimationFrame(time, frame) {        
        const pose = frame.getViewerPose(refSpace);
        if (!pose) return;

        videoPlayer.render(frame);
        frame.session.requestAnimationFrame(onAnimationFrame);
      }

      function onEndSession(session) {
        xrButton.setSession(null);
        renderer = null;
      }

      class VideoPlayer {
        constructor(layerType, videoSrc) {
          this._renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
          });

          this._renderer.xr.enabled = true;
          this._renderer.setSize(1280, 105);

          this._xrMediaBinding = null;
          this._xrWebGlBinding = null;
          this._quadWebGlLayer = null;
          this._quadMediaLayer = null;
          this._equirectMediaLayer = null;

          this._layoutType = layerType;
          this._videoSrc = videoSrc;
          this._video = null;
          this._timeoutId = null;
          this._isPlaying = false;
          this._showingProgressBar = false;

          this._scene = new THREE.Scene();
          this._camera = new THREE.OrthographicCamera(0, innerWidth * 2, 0, innerHeight * -2);
          this._camera.position.z = 1;

          const gl = this._renderer.getContext();
          const spriteBackground = VideoPlayer.createCube(0xffffff, { x: 168.6, y: -457.5, opacity: 0.75 });
          this._playSprite = VideoPlayer.createSprite("./media/textures/play-button.png", { x: 168.6, y: -457.5 });
          this._pauseSprite = VideoPlayer.createSprite("./media/textures/pause-button.png", { x: 168.6, y: -457.5 });

          this._scene.add(spriteBackground);
          this._scene.add(this._pauseSprite);
          this._scene.add(this._playSprite);
          this._scene.add(this._camera);

          this._framebuffer = gl.createFramebuffer();
          this._readFramebuffer = gl.createFramebuffer();
        }

        get video() { return this._video; }
        get showingProgressBar() { return this._showingProgressBar; }
        get isPlaying() { return this._isPlaying; }

        _determinePlayPauseVisibility() {
          this._playSprite.visible = false;
          this._pauseSprite.visible = false;

          if (this._showingProgressBar) {
            if (this._isPlaying) this._pauseSprite.visible = true;
            else this._playSprite.visible = true;
          }
        }

        _initializeVideoElement() {
          const video = document.createElement("video");
          video.src = this._videoSrc;
          video.loop = true;
          video.volume = 1;

          video.addEventListener("play", () => {
            this.showProgressBar();
            this._isPlaying = true;
          });

          video.addEventListener("pause", () => {
            this.showProgressBar();
            this._isPlaying = false;
          });

          return new Promise(resolve => {
            video.addEventListener("loadeddata", () => {
              return resolve(video);
            });
          });
        }

        async initializeXRBindings(session) {
          const gl = this._renderer.getContext();
          this._video = await this._initializeVideoElement();
          document.body.appendChild(gl.canvas);
          await gl.makeXRCompatible();

          this._xrMediaBinding = new XRMediaBinding(session);
          this._xrWebGlBinding = new XRWebGLBinding(session, gl);
        }

        async createQuadMediaLayer(refSpace, { hideToolbar } = {}) {
          this._quadMediaLayer = this._xrMediaBinding.createQuadLayer(this._video, {
            space: refSpace.getOffsetReferenceSpace(new XRRigidTransform({ x: 0.0, y: 0.0, z: 0.0, w: 1.0 })),
            transform: new XRRigidTransform({ x: 0.0, y: 1.3, z: -RANGE, w: 1.0 }),
            layout: this._layoutType,
          });

          if (!hideToolbar) {
            this._quadWebGlLayer = this._xrWebGlBinding.createQuadLayer({
              layout: "mono",
              space: refSpace.getOffsetReferenceSpace(new XRRigidTransform({ x: 0.0, y: 0.0, z: 0.0, w: 1.0 })),
              transform: new XRRigidTransform({ x: 0.0, y: 0.8175, z: -RANGE, w: 1.0 }),
              viewPixelHeight: 105,
              viewPixelWidth: 1280,
              height: 105 / 1280,
              width: 1,
            });
          }

          return [this._quadMediaLayer, this._quadWebGlLayer];
        }

        async createEquirectMediaLayer(refSpace) {
          this._equirectMediaLayer = this._xrMediaBinding.createEquirectLayer(this._video, { space: refSpace });
          return [this._equirectMediaLayer];
        }

        hideProgressBar() {
          this._showingProgressBar = false;
          this._renderer.setClearColor(0x000000, 0);
          for (let child of this._scene.children) { 
            child.visible = false;
          }
        }

        showProgressBar() {
          this._showingProgressBar = true;
          this._renderer.setClearColor(0x000000, 0.75);
          for (let child of this._scene.children) { 
            child.visible = true;
          }
          
          if (this._timeoutId) clearTimeout(this._timeoutId);
          this._timeoutId = setTimeout(this.hideProgressBar.bind(this), 4000);
        }

        render(frame) {
          const gl = this._renderer.getContext();
          const glSubImage = this._xrWebGlBinding.getSubImage(this._quadWebGlLayer, frame);
          this._determinePlayPauseVisibility();

          gl.bindFramebuffer(gl.FRAMEBUFFER, this._framebuffer);
          gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, glSubImage.colorTexture, 0);
          gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this._readFramebuffer);

          this._renderer.render(this._scene, this._camera);
        }

        static createCube(color, { x, y, z, opacity }) {
          const geometry = new THREE.BoxGeometry(1, 1, 1);
          const material = new THREE.MeshBasicMaterial({ color, opacity });
          const cube = new THREE.Mesh(geometry, material);

          cube.scale.x = 650 / 7;
          cube.scale.y = 650;

          cube.position.x = x || 0;
          cube.position.y = y || 0;
          cube.position.z = z || 0;

          return cube;
        }

        static createSprite(resourceUrl, { x, y, z }) {
          const spriteMap = new THREE.TextureLoader().load(resourceUrl);
          const spriteMaterial = new THREE.SpriteMaterial({ map: spriteMap });
          const sprite = new THREE.Sprite(spriteMaterial);

          sprite.scale.x = SPRITE_SCALE / 7;
          sprite.scale.y = SPRITE_SCALE;
          sprite.scale.z = SPRITE_SCALE;

          sprite.position.x = x || 0;
          sprite.position.y = y || 0;
          sprite.position.z = z || 0;

          return sprite;
        } 
      }

      // Start the XR application.
      initXR();
    </script>
  </body>
</html>
