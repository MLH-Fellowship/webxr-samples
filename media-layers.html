<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="stylesheet" href="css/common.css">

    <title>Media Layers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"
      integrity="sha512-yNJzAsg5JyP91u+sLHlUDULMBd3hmEiVkYeeN1cQBKaLZ7EyT6oH2u5THNIRM2Fu6VKcZJv+F/QAp1h/qzy9Ow=="
      crossorigin="anonymous"></script>
  </head>
  <body>
    <header>
      <details open>
        <summary>Media Layers</summary>
        <p>
          Demonstrates using the Media Layers API to create a high-quality video player inside of an "immersive-vr" session.
          <a class="back" href="./">Back</a>
        </p>
        <label>Choose the media"s layout:</label>
        <select id="layoutselect">
          <option value="/media/video/60fps.mp4">
            mono
          </option>
          <option value="/media/video/bbb-sunflower-540p2-1min.webm">
            stereo-top-bottom
          </option>
        </select>
        <p>Trigger = Squeeze = play / pause the video</p>
      </details>
    </header>
    <main style="text-align: center;">
      <p>Click "Enter VR" to see content</p>
    </main>
    <script type="module">
      import { WebXRButton } from "./js/util/webxr-button.js";
      import { QueryArgs } from "./js/util/query-args.js";

      // If requested, use the polyfill to provide support for mobile devices
      // and devices which only support WebVR.
      import WebXRPolyfill from "./js/third-party/webxr-polyfill/build/webxr-polyfill.module.js";
      if (QueryArgs.getBool("usePolyfill", true)) {
        let polyfill = new WebXRPolyfill();
      }

      let xrButton = null;
      const RANGE = 2.75;
      const SPRITE_SCALE = 550;

      let refSpace = null;
      let session = null;

      let gl = null;
      let scene = null;
      let camera = null;
      let renderer = null;
      let cube = null;

      let video = null;
      let framebuffer = null;
      let readFramebuffer = null;

      let xrMediaBinding = null;
      let xrWebGlBinding = null;
      let quadMediaLayer = null;
      let quadWebGlLayer = null;

      let playSprite = null;
      let pauseSprite = null;

      let timeoutId = null;
      let lastHandedness = null;
      let showingProgressBar = false;
      let isPlaying = false;

      function initXR() {
        xrButton = new WebXRButton({ onRequestSession, onEndSession });
        document.querySelector("header").appendChild(xrButton.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported("immersive-vr").then(supported => {
            xrButton.enabled = supported;
          });
        }
      }

      function onRequestSession() {
        navigator.xr.requestSession("immersive-vr", {
          requiredFeatures: ["layers", "local-floor"],
        }).then(session => {
          xrButton.setSession(session);
          initializeSession(session);
        });
      }

      async function initializeSession(session) {
        scene = new THREE.Scene();
        renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true
        });

        if (gl) gl.canvas.remove();
        gl = renderer.getContext();

        renderer.xr.enabled = true;
        renderer.setSize(1280, 105);

        framebuffer = gl.createFramebuffer();
        readFramebuffer = gl.createFramebuffer();

        const layoutSelect = document.getElementById("layoutselect");
        const videoSource = layoutSelect.options[layoutSelect.selectedIndex].value;
        const layout = layoutSelect.options[layoutSelect.selectedIndex].text;
      
        await gl.makeXRCompatible();
        await initializeVideo(videoSource);
        startSession(session, layout);
      }

      function initializeVideo(source) {
        video = document.createElement("video");
        video.src = source;
        video.loop = true;
        video.volume = 1;

        video.addEventListener("play", () => {
          showProgressBar();
          isPlaying = true;
        });

        video.addEventListener("pause", () => {
          showProgressBar();
          isPlaying = false;
        });

        return new Promise(resolve => {
          video.addEventListener("loadeddata", resolve);
        });
      }

      async function startSession(session, layout) {
        document.body.appendChild(gl.canvas);
        session.requestReferenceSpace("local-floor")
          .then(referenceSpace => {
            refSpace = referenceSpace;
            xrMediaBinding = new XRMediaBinding(session);
            xrWebGlBinding = new XRWebGLBinding(session, gl);

            const equirectMediaLayer = xrMediaBinding.createEquirectLayer(video, { space: refSpace });
            quadMediaLayer = xrMediaBinding.createQuadLayer(video, {
              space: refSpace.getOffsetReferenceSpace(new XRRigidTransform({ x: 0.0, y: 0.0, z: 0.0, w: 1.0 })),
              transform: new XRRigidTransform({ x: 0.0, y: 1.3, z: -RANGE, w: 1.0 }),
              layout,
            });

            quadWebGlLayer = xrWebGlBinding.createQuadLayer({
              layout: "mono",
              space: refSpace.getOffsetReferenceSpace(new XRRigidTransform({ x: 0.0, y: 0.0, z: 0.0, w: 1.0 })),
              transform: new XRRigidTransform({ x: 0.0, y: 0.8175, z: -RANGE, w: 1.0 }),
              viewPixelHeight: 105,
              viewPixelWidth: 1280,
              height: 105 / 1280,
              width: 1,
            });

            camera = new THREE.OrthographicCamera(0, innerWidth * 2, 0, innerHeight * -2);
            camera.position.z = 1;
            scene.add(camera);

            cube = createCube(0xffffff, { x: 168.6, y: -457.5, opacity: 0.75 });
            scene.add(cube);

            playSprite = createSprite("/media/textures/play-button.png", { x: 168.6, y: -457.5 });
            pauseSprite = createSprite("/media/textures/pause-button.png", { x: 168.6, y: -457.5 });
            scene.add(pauseSprite);
            scene.add(playSprite);

            session.addEventListener("squeeze", evt => {
              if (isPlaying) video.pause();
              else video.play();
            });

            session.addEventListener("select", evt => {
              if (isPlaying) video.pause();
              else video.play();
            });

            const layers = [equirectMediaLayer, quadMediaLayer, quadWebGlLayer];
            session.updateRenderState({ layers });
            
            video.play();
            session.requestAnimationFrame(onAnimationFrame);            
          });
      }

      function onAnimationFrame(time, frame) {        
        const pose = frame.getViewerPose(refSpace);
        if (!pose) return;

        const glSubImage = xrWebGlBinding.getSubImage(quadWebGlLayer, frame);
        determinePlayPauseVisibility();

        gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, glSubImage.colorTexture, 0);
        gl.bindFramebuffer(gl.READ_FRAMEBUFFER, readFramebuffer);

        renderer.render(scene, camera);
        frame.session.requestAnimationFrame(onAnimationFrame);
      }

      function onEndSession(session) {
        xrButton.setSession(null);
        session.end();
        renderer = null;
      }

      function createCube(color, { x, y, z, opacity }) {
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshBasicMaterial({ color, opacity });
        const cube = new THREE.Mesh(geometry, material);

        cube.scale.x = 650 / 7;
        cube.scale.y = 650;

        cube.position.x = x || 0;
        cube.position.y = y || 0;
        cube.position.z = z || 0;

        return cube;
      }

      function createSprite(resourceUrl, { x, y, z }) {
        const spriteMap = new THREE.TextureLoader().load(resourceUrl);
        const spriteMaterial = new THREE.SpriteMaterial({ map: spriteMap });
        const sprite = new THREE.Sprite(spriteMaterial);

        sprite.scale.x = SPRITE_SCALE / 7;
        sprite.scale.y = SPRITE_SCALE;
        sprite.scale.z = SPRITE_SCALE;

        sprite.position.x = x || 0;
        sprite.position.y = y || 0;
        sprite.position.z = z || 0;

        return sprite;
      }

      function determinePlayPauseVisibility() {
        playSprite.visible = false;
        pauseSprite.visible = false;

        if (showingProgressBar) {
          if (isPlaying) pauseSprite.visible = true;
          else playSprite.visible = true;
        }
      }

      function hideProgressBar() {
        showingProgressBar = false;
        renderer.setClearColor(0x000000, 0);
        for (let child of scene.children) { 
          child.visible = false;
        }
      }

      function showProgressBar() {
        showingProgressBar = true;
        renderer.setClearColor(0x000000, 0.75);
        for (let child of scene.children) { 
          child.visible = true;
        }
        
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(hideProgressBar, 4000);
      }

      // Start the XR application.
      initXR();
    </script>
  </body>
</html>
